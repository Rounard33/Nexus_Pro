 <div class="client-detail">
  <!-- Bouton retour -->
  <button class="back-button" (click)="goBack()">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="15 18 9 12 15 6"/>
    </svg>
    <span>Retour à la liste</span>
  </button>

  <!-- État de chargement -->
  <div class="loading-state" *ngIf="isLoading">
    <p>Chargement des détails...</p>
  </div>

  <!-- Contenu principal -->
  <div class="client-detail-content" *ngIf="!isLoading && client">
    <!-- En-tête client -->
    <div class="client-header-card">
      <div class="client-header-main">
        <div class="client-avatar-large">
          <span class="avatar-initial">{{ client.name.charAt(0).toUpperCase() }}</span>
        </div>
        <div class="client-header-info">
          <h1 class="client-detail-name">{{ client.name }}</h1>
          <div class="client-contact-info">
            <div class="contact-item">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                <polyline points="22,6 12,13 2,6"/>
              </svg>
              <span>{{ client.email }}</span>
            </div>
            <div class="contact-item" *ngIf="client.phone">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
              </svg>
              <span>{{ client.phone }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Statistiques -->
      <div class="client-stats-container">
        <!-- Statistiques des rendez-vous -->
        <div class="stats-section">
          <h3 class="stats-section-title">Rendez-vous</h3>
          <div class="client-stats-grid appointments-stats">
            <div class="stat-card">
              <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M12 6v6l4 2"/>
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-value">{{ client.totalAppointments }}</span>
                <span class="stat-label">Rendez-vous total</span>
              </div>
            </div>
            <div class="stat-card stat-accepted">
              <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-value">{{ client.acceptedAppointments }}</span>
                <span class="stat-label">Acceptés</span>
              </div>
            </div>
            <div class="stat-card stat-pending" *ngIf="client.pendingAppointments > 0">
              <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="12" y1="8" x2="12" y2="12"/>
                  <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-value">{{ client.pendingAppointments }}</span>
                <span class="stat-label">En attente</span>
              </div>
            </div>
            <div class="stat-card stat-rejected" *ngIf="client.rejectedAppointments > 0">
              <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="15" y1="9" x2="9" y2="15"/>
                  <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-value">{{ client.rejectedAppointments }}</span>
                <span class="stat-label">Refusés</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Statistiques de performance -->
        <div class="stats-section">
          <h3 class="stats-section-title">Performance</h3>
          <div class="client-stats-grid performance-stats">
            <div class="stat-card stat-info">
              <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                  <circle cx="12" cy="7" r="4"/>
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-value">{{ getClientVisitsCount() }}</span>
                <span class="stat-label">Nombre de venues</span>
              </div>
            </div>
            <div class="stat-card stat-success">
              <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
                  <line x1="3" y1="6" x2="21" y2="6"/>
                  <path d="M16 10a4 4 0 0 1-8 0"/>
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-value">{{ clientAverageBasket }}€</span>
                <span class="stat-label">Panier moyen</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Date de naissance et anniversaire -->
      <div class="client-birthdate-section">
        <div class="birthdate-header">
          <h3 class="birthdate-title">Date de naissance</h3>
          <button 
            class="edit-birthdate-btn" 
            *ngIf="!isEditingBirthdate"
            (click)="startEditingBirthdate()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
            <span>{{ client.birthdate ? 'Modifier' : 'Ajouter' }}</span>
          </button>
        </div>

        <!-- Mode affichage -->
        <div class="birthdate-display" *ngIf="!isEditingBirthdate">
          <div class="birthdate-info">
            <div class="birthdate-item">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
              <div class="birthdate-details">
                <span class="birthdate-label">Date de naissance :</span>
                <span class="birthdate-value">{{ formatBirthdate(client.birthdate) }}</span>
                <span class="birthdate-age" *ngIf="client.age !== null && client.age !== undefined">
                  ({{ client.age }} ans)
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Mode édition -->
        <div class="birthdate-edit" *ngIf="isEditingBirthdate">
          <div class="edit-form">
            <label for="birthdate-input" class="edit-label">Date de naissance</label>
            <input
              type="date"
              id="birthdate-input"
              [(ngModel)]="birthdateInput"
              class="edit-input"
              [max]="getMaxDate()"
              [disabled]="isSaving">
            <div class="edit-actions">
              <button 
                class="save-btn" 
                (click)="saveBirthdate()"
                [disabled]="isSaving">
                <span *ngIf="!isSaving">Enregistrer</span>
                <span *ngIf="isSaving">Enregistrement...</span>
              </button>
              <button 
                class="cancel-btn" 
                (click)="cancelEditingBirthdate()"
                [disabled]="isSaving">
                Annuler
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Dates importantes -->
      <div class="client-dates">
        <div class="date-item" *ngIf="client.firstAppointmentDate">
          <span class="date-label">Premier rendez-vous :</span>
          <span class="date-value">{{ formatDate(client.firstAppointmentDate) }}</span>
        </div>
        <div class="date-item" *ngIf="client.lastAppointmentDate">
          <span class="date-label">Dernier rendez-vous :</span>
          <span class="date-value">{{ formatDate(client.lastAppointmentDate) }}</span>
        </div>
      </div>

      <!-- Carte de fidélité -->
      <div class="loyalty-section">
        <div class="loyalty-header">
          <h3 class="loyalty-title">Carte de fidélité</h3>
          <span class="loyalty-badge" [class.loyalty-complete]="hasReachedLoyaltyThreshold()">
            {{ client.eligibleTreatments }}/5 soins
          </span>
        </div>

        <div class="loyalty-progress">
          <div class="loyalty-progress-bar">
            <div 
              class="loyalty-progress-fill" 
              [style.width.%]="(client.eligibleTreatments / 5) * 100"
              [class.loyalty-complete]="hasReachedLoyaltyThreshold()">
            </div>
          </div>
          <p class="loyalty-status" *ngIf="!hasReachedLoyaltyThreshold()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
            </svg>
            {{ getRemainingTreatments() }} soin{{ getRemainingTreatments() > 1 ? 's' : '' }} restant{{ getRemainingTreatments() > 1 ? 's' : '' }} avant la récompense
          </p>
          <p class="loyalty-status loyalty-ready" *ngIf="hasReachedLoyaltyThreshold()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            Récompense disponible : -10% + cadeau (bracelet avec pierre)
          </p>
        </div>

        <!-- Actions pour enregistrer les récompenses -->
        <div class="loyalty-actions" *ngIf="hasReachedLoyaltyThreshold()">
          <button 
            class="reward-btn reward-discount" 
            (click)="recordReward('discount', 'Réduction de 10% appliquée')"
            [disabled]="isSaving">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h7a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
            <span>Enregistrer -10%</span>
          </button>
          <button 
            class="reward-btn reward-gift" 
            (click)="recordReward('gift', 'Cadeau offert : bracelet avec pierre')"
            [disabled]="isSaving">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
            </svg>
            <span>Enregistrer cadeau</span>
          </button>
        </div>

        <!-- Historique des récompenses -->
        <div class="loyalty-rewards-history" *ngIf="client.loyaltyRewards && client.loyaltyRewards.length > 0">
          <h4 class="rewards-history-title">Historique des récompenses</h4>
          <div class="rewards-list">
            <div class="reward-item" *ngFor="let reward of client.loyaltyRewards">
              <div class="reward-icon" [class.reward-discount]="reward.type === 'discount'" [class.reward-gift]="reward.type === 'gift'">
                <svg *ngIf="reward.type === 'discount'" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h7a3.5 3.5 0 0 1 0 7H6"/>
                </svg>
                <svg *ngIf="reward.type === 'gift'" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                </svg>
              </div>
              <div class="reward-details">
                <span class="reward-description">{{ reward.description }}</span>
                <span class="reward-date">{{ formatDate(reward.date) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ventes additionnelles -->
    <div class="additional-sales-section">
      <div class="sales-header">
        <h3 class="sales-title">Ventes additionnelles</h3>
        <button 
          class="add-sale-btn" 
          (click)="openAddSaleForm()"
          [disabled]="isSaving">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"/>
            <line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          <span>Ajouter une vente</span>
        </button>
      </div>

      <!-- Formulaire d'ajout de vente -->
      <div class="add-sale-form" *ngIf="isAddingSale">
        <div class="form-group">
          <label class="form-label">Type de vente</label>
          <div class="sale-type-selector">
            <button 
              class="type-btn" 
              [class.active]="saleType === 'creation'"
              (click)="saleType = 'creation'">
              Création
            </button>
            <button 
              class="type-btn" 
              [class.active]="saleType === 'gift_card'"
              (click)="saleType = 'gift_card'">
              Carte cadeau
            </button>
          </div>
        </div>

        <div class="form-group" *ngIf="saleType === 'creation'">
          <label for="creation-select" class="form-label">Création vendue *</label>
          <select 
            id="creation-select"
            [(ngModel)]="selectedCreationId"
            class="form-select"
            [disabled]="isSaving">
            <option value="">Sélectionner une création</option>
            <option *ngFor="let creation of creations" [value]="creation.id">
              {{ creation.name }} - {{ creation.price }}
            </option>
          </select>
        </div>

        <div class="form-group" *ngIf="saleType === 'gift_card'">
          <label for="gift-card-amount" class="form-label">Montant de la carte cadeau (€) *</label>
          <input 
            type="number"
            id="gift-card-amount"
            [(ngModel)]="giftCardAmount"
            class="form-input"
            min="0"
            step="0.01"
            placeholder="0.00"
            [disabled]="isSaving">
        </div>

        <div class="form-group">
          <label for="sale-notes" class="form-label">Notes (optionnel)</label>
          <textarea 
            id="sale-notes"
            [(ngModel)]="saleNotes"
            class="form-textarea"
            rows="3"
            placeholder="Notes supplémentaires..."
            [disabled]="isSaving"></textarea>
        </div>

        <div class="form-actions">
          <button 
            class="save-btn" 
            (click)="saveSale()"
            [disabled]="isSaving || (saleType === 'creation' && !selectedCreationId) || (saleType === 'gift_card' && (!giftCardAmount || giftCardAmount <= 0))">
            <span *ngIf="!isSaving">Enregistrer</span>
            <span *ngIf="isSaving">Enregistrement...</span>
          </button>
          <button 
            class="cancel-btn" 
            (click)="cancelAddSale()"
            [disabled]="isSaving">
            Annuler
          </button>
        </div>
      </div>

      <!-- Liste des ventes -->
      <div class="sales-list" *ngIf="client.additionalSales && client.additionalSales.length > 0">
        <div class="sale-item" *ngFor="let sale of client.additionalSales">
          <div class="sale-icon" [class.sale-creation]="sale.type === 'creation'" [class.sale-gift-card]="sale.type === 'gift_card'">
            <svg *ngIf="sale.type === 'creation'" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
              <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
              <line x1="12" y1="22.08" x2="12" y2="12"/>
            </svg>
            <svg *ngIf="sale.type === 'gift_card'" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
              <line x1="1" y1="10" x2="23" y2="10"/>
            </svg>
          </div>
          <div class="sale-details">
            <span class="sale-description">{{ getSaleDescription(sale) }}</span>
            <span class="sale-date">{{ formatDate(sale.date) }}</span>
            <span class="sale-notes" *ngIf="sale.notes">{{ sale.notes }}</span>
          </div>
          <button 
            class="delete-sale-btn" 
            (click)="deleteSale(sale)"
            [disabled]="isSaving"
            title="Supprimer cette vente">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"/>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              <line x1="10" y1="11" x2="10" y2="17"/>
              <line x1="14" y1="11" x2="14" y2="17"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="empty-state" *ngIf="!client.additionalSales || client.additionalSales.length === 0">
        <p>Aucune vente additionnelle enregistrée</p>
      </div>
    </div>

    <!-- Historique des rendez-vous -->
    <div class="appointments-history">
      <h2 class="section-title">Historique des rendez-vous</h2>
      
      <div class="appointments-list" *ngIf="client.appointments.length > 0">
        <div class="appointment-item" *ngFor="let appointment of client.appointments">
          <div class="appointment-date-time">
            <div class="appointment-date">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
              <span>{{ formatDate(appointment.appointment_date) }}</span>
            </div>
            <div class="appointment-time">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 6v6l4 2"/>
              </svg>
              <span>{{ formatTime(appointment.appointment_time) }}</span>
            </div>
          </div>

          <div class="appointment-details">
            <div class="appointment-prestation" *ngIf="hasPrestation(appointment)">
              <strong>Prestation :</strong>
              <span>{{ appointment.prestations?.name }}</span>
            </div>
            <div class="appointment-prestation" *ngIf="!hasPrestation(appointment) && appointment.prestation_id">
              <strong>Prestation :</strong>
              <span class="text-muted">Prestation supprimée</span>
            </div>
            <div class="appointment-notes" *ngIf="appointment.notes">
              <strong>Notes :</strong>
              <span>{{ appointment.notes }}</span>
            </div>
          </div>

          <div class="appointment-status">
            <span class="status-badge" [ngClass]="getStatusClass(appointment.status)">
              {{ getStatusLabel(appointment.status) }}
            </span>
          </div>
        </div>
      </div>

      <div class="empty-state" *ngIf="client.appointments.length === 0">
        <p>Aucun rendez-vous enregistré</p>
      </div>
    </div>
  </div>
</div>

