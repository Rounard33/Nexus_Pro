<div class="appointments">
  <div class="page-header">
    <h1 class="page-title">Gestion des rendez-vous</h1>
  </div>

  <!-- Filtres -->
  <div class="filters-card">
    <div class="filters-row">
      <div class="filter-group">
        <label for="statusFilter" class="filter-label">Statut</label>
        <select id="statusFilter" [(ngModel)]="statusFilter" (ngModelChange)="applyFilters()" class="filter-select">
          <option value="all">Tous</option>
          <option value="pending">En attente</option>
          <option value="accepted">Acceptés</option>
          <option value="rejected">Refusés</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="dateFilter" class="filter-label">Période</label>
        <select id="dateFilter" [(ngModel)]="dateFilter" (ngModelChange)="applyFilters()" class="filter-select">
          <option value="all">Toutes</option>
          <option value="today">Aujourd'hui</option>
          <option value="week">Cette semaine</option>
          <option value="month">Ce mois</option>
          <option value="custom">Personnalisé</option>
        </select>
      </div>

      <div class="filter-group" *ngIf="dateFilter === 'custom'">
        <label for="customStartDate" class="filter-label">Du</label>
        <input type="date" id="customStartDate" [(ngModel)]="customStartDate" (ngModelChange)="applyFilters()" class="filter-input">
      </div>

      <div class="filter-group" *ngIf="dateFilter === 'custom'">
        <label for="customEndDate" class="filter-label">Au</label>
        <input type="date" id="customEndDate" [(ngModel)]="customEndDate" (ngModelChange)="applyFilters()" class="filter-input">
      </div>

      <div class="filter-group filter-search">
        <label for="searchTerm" class="filter-label">Recherche</label>
        <input 
          type="text" 
          id="searchTerm" 
          [(ngModel)]="searchTerm" 
          (ngModelChange)="onSearchChange()" 
          placeholder="Nom ou email..."
          class="filter-input"
          aria-label="Rechercher un rendez-vous par nom ou email">
      </div>
    </div>
  </div>

  <!-- Tableau (Desktop) -->
  <div class="table-card">
    <div class="table-responsive" *ngIf="!isLoading">
      <table class="appointments-table">
        <thead>
          <tr>
            <th>Client</th>
            <th>Email</th>
            <th>Prestation</th>
            <th>Date</th>
            <th>Heure</th>
            <th>Âge enfant</th>
            <th>Statut</th>
            <th>Paiement</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let appointment of filteredAppointments">
            <td class="client-name">{{ appointment.client_name }}</td>
            <td class="client-email">{{ appointment.client_email }}</td>
            <td class="prestation-name">
              <span *ngIf="hasPrestation(appointment)">{{ appointment.prestations?.name }}</span>
              <span *ngIf="!hasPrestation(appointment) && appointment.prestation_id" class="text-muted">
                Prestation supprimée (ID: {{ appointment.prestation_id }})
              </span>
              <span *ngIf="!hasPrestation(appointment) && !appointment.prestation_id" class="text-muted">
                Non renseignée
              </span>
            </td>
            <td>{{ appointment.appointment_date | date:'dd/MM/yyyy' }}</td>
            <td>{{ appointment.appointment_time }}</td>
            <td class="child-age-cell">
              <span *ngIf="hasChildAge(appointment)" class="child-age-badge">
                {{ formatChildAge(appointment.child_age) }}
              </span>
              <span *ngIf="!hasChildAge(appointment)" class="text-muted">-</span>
            </td>
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(appointment.status)">
                {{ getStatusLabel(appointment.status) }}
              </span>
            </td>
            <td class="payment-cell">
              <span *ngIf="appointment.payment_method" class="payment-badge">
                {{ getPaymentMethodLabel(appointment.payment_method) }}
              </span>
              <span *ngIf="!appointment.payment_method" class="text-muted">-</span>
            </td>
            <td class="actions-cell">
              <div class="actions-buttons">
                <button 
                  class="btn-action btn-details" 
                  (click)="openDetails(appointment)"
                  title="Voir détails">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                </button>
                <button 
                  *ngIf="appointment.status === 'pending'"
                  class="btn-action btn-accept" 
                  (click)="updateStatus(appointment, 'accepted')"
                  [disabled]="isUpdating(appointment)"
                  [attr.aria-label]="'Accepter le rendez-vous de ' + appointment.client_name"
                  [title]="isUpdating(appointment) ? 'Mise à jour en cours...' : 'Accepter'"
                  type="button">
                  <svg *ngIf="!isUpdating(appointment)" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                  </svg>
                  <span *ngIf="isUpdating(appointment)" class="spinner" aria-hidden="true"></span>
                </button>
                <button 
                  *ngIf="appointment.status === 'pending'"
                  class="btn-action btn-reject" 
                  (click)="updateStatus(appointment, 'rejected')"
                  [disabled]="isUpdating(appointment)"
                  [attr.aria-label]="'Refuser le rendez-vous de ' + appointment.client_name"
                  [title]="isUpdating(appointment) ? 'Mise à jour en cours...' : 'Refuser'"
                  type="button">
                  <svg *ngIf="!isUpdating(appointment)" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="15" y1="9" x2="9" y2="15"/>
                    <line x1="9" y1="9" x2="15" y2="15"/>
                  </svg>
                  <span *ngIf="isUpdating(appointment)" class="spinner" aria-hidden="true"></span>
                </button>
                <button 
                  *ngIf="appointment.status === 'accepted' && isAppointmentPast(appointment)"
                  class="btn-action btn-complete" 
                  (click)="updateStatus(appointment, 'completed')"
                  [disabled]="isUpdating(appointment)"
                  [attr.aria-label]="'Marquer comme terminé le rendez-vous de ' + appointment.client_name"
                  [title]="isUpdating(appointment) ? 'Mise à jour en cours...' : 'Marquer comme terminé'"
                  type="button">
                  <svg *ngIf="!isUpdating(appointment)" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                  </svg>
                  <span *ngIf="isUpdating(appointment)" class="spinner" aria-hidden="true"></span>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="empty-state" *ngIf="filteredAppointments.length === 0">
        <p>Aucun rendez-vous trouvé</p>
      </div>
    </div>

    <div class="loading-state" *ngIf="isLoading">
      <p>Chargement...</p>
    </div>
  </div>

  <!-- Cartes (Mobile) -->
  <div class="appointment-cards" *ngIf="!isLoading">
    <div class="appointment-card" *ngFor="let appointment of filteredAppointments">
      <div class="appointment-card-header">
        <div class="appointment-card-info">
          <h4 class="appointment-card-name">{{ appointment.client_name }}</h4>
          <p class="appointment-card-email">{{ appointment.client_email }}</p>
        </div>
        <span class="status-badge" [ngClass]="getStatusClass(appointment.status)">
          {{ getStatusLabel(appointment.status) }}
        </span>
      </div>
      <div class="appointment-card-body">
        <div class="appointment-card-row">
          <span class="appointment-card-label">Prestation:</span>
          <span class="appointment-card-value">
            <span *ngIf="hasPrestation(appointment)">{{ appointment.prestations?.name }}</span>
            <span *ngIf="!hasPrestation(appointment) && appointment.prestation_id" class="text-muted">
              Prestation supprimée (ID: {{ appointment.prestation_id }})
            </span>
            <span *ngIf="!hasPrestation(appointment) && !appointment.prestation_id" class="text-muted">
              Non renseignée
            </span>
          </span>
        </div>
        <div class="appointment-card-row">
          <span class="appointment-card-label">Date:</span>
          <span class="appointment-card-value">{{ appointment.appointment_date | date:'dd/MM/yyyy' }}</span>
        </div>
        <div class="appointment-card-row">
          <span class="appointment-card-label">Heure:</span>
          <span class="appointment-card-value">{{ appointment.appointment_time }}</span>
        </div>
        <div class="appointment-card-row" *ngIf="hasChildAge(appointment)">
          <span class="appointment-card-label">Âge de l'enfant:</span>
          <span class="appointment-card-value child-age-value">
            {{ formatChildAge(appointment.child_age) }}
          </span>
        </div>
        <div class="appointment-card-row">
          <span class="appointment-card-label">Paiement:</span>
          <span class="appointment-card-value">
            <span *ngIf="appointment.payment_method" class="payment-badge-small">
              {{ getPaymentMethodLabel(appointment.payment_method) }}
            </span>
            <span *ngIf="!appointment.payment_method" class="text-muted">Non renseigné</span>
          </span>
        </div>
      </div>
      <div class="appointment-card-actions">
        <button 
          class="appointment-card-action-btn appointment-card-action-btn-details" 
          (click)="openDetails(appointment)"
          aria-label="Voir détails">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
          Détails
        </button>
        <button 
          *ngIf="appointment.status === 'pending'"
          class="appointment-card-action-btn appointment-card-action-btn-accept" 
          (click)="updateStatus(appointment, 'accepted')"
          [disabled]="isUpdating(appointment)"
          [attr.aria-label]="'Accepter le rendez-vous de ' + appointment.client_name"
          type="button">
          <svg *ngIf="!isUpdating(appointment)" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          <span *ngIf="isUpdating(appointment)" class="spinner" aria-hidden="true"></span>
          <span *ngIf="!isUpdating(appointment)">Accepter</span>
        </button>
        <button 
          *ngIf="appointment.status === 'pending'"
          class="appointment-card-action-btn appointment-card-action-btn-reject" 
          (click)="updateStatus(appointment, 'rejected')"
          [disabled]="isUpdating(appointment)"
          [attr.aria-label]="'Refuser le rendez-vous de ' + appointment.client_name"
          type="button">
          <svg *ngIf="!isUpdating(appointment)" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
          </svg>
          <span *ngIf="isUpdating(appointment)" class="spinner" aria-hidden="true"></span>
          <span *ngIf="!isUpdating(appointment)">Refuser</span>
        </button>
        <button 
          *ngIf="appointment.status === 'accepted' && isAppointmentPast(appointment)"
          class="appointment-card-action-btn appointment-card-action-btn-complete" 
          (click)="updateStatus(appointment, 'completed')"
          [disabled]="isUpdating(appointment)"
          [attr.aria-label]="'Marquer comme terminé le rendez-vous de ' + appointment.client_name"
          type="button">
          <svg *ngIf="!isUpdating(appointment)" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          <span *ngIf="isUpdating(appointment)" class="spinner" aria-hidden="true"></span>
          <span *ngIf="!isUpdating(appointment)">Terminé</span>
        </button>
      </div>
    </div>
    <div class="empty-state" *ngIf="filteredAppointments.length === 0">
      <p>Aucun rendez-vous trouvé</p>
    </div>
  </div>

  <!-- Modal détails -->
  <div class="modal-overlay" *ngIf="showDetailsModal && selectedAppointment" (click)="closeDetails()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="closeDetails()" aria-label="Fermer">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>

      <h2 class="modal-title">Détails du rendez-vous</h2>

      <div class="modal-body">
        <div class="detail-row">
          <strong>Client:</strong>
          <span>{{ selectedAppointment.client_name }}</span>
        </div>
        <div class="detail-row">
          <strong>Email:</strong>
          <span>{{ selectedAppointment.client_email }}</span>
        </div>
        <div class="detail-row" *ngIf="selectedAppointment.client_phone">
          <strong>Téléphone:</strong>
          <span>{{ selectedAppointment.client_phone }}</span>
        </div>
        <div class="detail-row">
          <strong>Prestation:</strong>
          <span *ngIf="hasPrestation(selectedAppointment)">{{ selectedAppointment.prestations?.name }}</span>
          <span *ngIf="!hasPrestation(selectedAppointment) && selectedAppointment.prestation_id" class="text-muted">
            Prestation supprimée (ID: {{ selectedAppointment.prestation_id }})
          </span>
          <span *ngIf="!hasPrestation(selectedAppointment) && !selectedAppointment.prestation_id" class="text-muted">
            Non renseignée
          </span>
        </div>
        <div class="detail-row">
          <strong>Date:</strong>
          <span>{{ selectedAppointment.appointment_date | date:'dd/MM/yyyy' }}</span>
        </div>
        <div class="detail-row">
          <strong>Heure:</strong>
          <span>{{ selectedAppointment.appointment_time }}</span>
        </div>
        <div class="detail-row" *ngIf="hasChildAge(selectedAppointment)">
          <strong>Âge de l'enfant:</strong>
          <span class="child-age-detail">{{ formatChildAge(selectedAppointment.child_age) }}</span>
        </div>
        <div class="detail-row">
          <strong>Statut:</strong>
          <span class="status-badge" [ngClass]="getStatusClass(selectedAppointment.status)">
            {{ getStatusLabel(selectedAppointment.status) }}
          </span>
        </div>
        <div class="detail-row detail-row-editable">
          <strong>Mode de paiement:</strong>
          <select 
            [(ngModel)]="selectedAppointment.payment_method"
            (change)="updatePaymentMethod(selectedAppointment)"
            [disabled]="isUpdating(selectedAppointment)"
            class="payment-select"
            aria-label="Mode de paiement">
            <option [value]="null">Non renseigné</option>
            <option value="espèces">Espèces</option>
            <option value="carte">Carte bancaire</option>
            <option value="virement">Virement</option>
            <option value="chèque">Chèque</option>
          </select>
          <span *ngIf="isUpdating(selectedAppointment)" class="updating-indicator">
            <span class="spinner-small" aria-hidden="true"></span>
          </span>
        </div>
        <div class="detail-row" *ngIf="selectedAppointment.notes">
          <strong>Notes:</strong>
          <span>{{ selectedAppointment.notes }}</span>
        </div>
        <div class="detail-row" *ngIf="selectedAppointment.referral_source">
          <strong>Comment avez-vous connu le site ?</strong>
          <span>{{ getReferralSourceLabel(selectedAppointment.referral_source) }}</span>
        </div>
        <div class="detail-row" *ngIf="selectedAppointment.referral_source === 'friend' && selectedAppointment.referral_friend_name">
          <strong>Nom de la personne qui a recommandé:</strong>
          <span>{{ selectedAppointment.referral_friend_name }}</span>
        </div>
      </div>

      <div class="modal-actions">
        <button 
          *ngIf="selectedAppointment.status === 'pending'"
          class="btn btn-accept" 
          (click)="updateStatus(selectedAppointment, 'accepted')"
          [disabled]="isUpdating(selectedAppointment)"
          aria-label="Accepter ce rendez-vous">
          <span *ngIf="isUpdating(selectedAppointment)">Mise à jour...</span>
          <span *ngIf="!isUpdating(selectedAppointment)">Accepter</span>
        </button>
        <button 
          *ngIf="selectedAppointment.status === 'pending'"
          class="btn btn-reject" 
          (click)="updateStatus(selectedAppointment, 'rejected')"
          [disabled]="isUpdating(selectedAppointment)"
          aria-label="Refuser ce rendez-vous">
          <span *ngIf="isUpdating(selectedAppointment)">Mise à jour...</span>
          <span *ngIf="!isUpdating(selectedAppointment)">Refuser</span>
        </button>
        <button 
          *ngIf="selectedAppointment.status === 'accepted' && isAppointmentPast(selectedAppointment)"
          class="btn btn-complete" 
          (click)="updateStatus(selectedAppointment, 'completed')"
          [disabled]="isUpdating(selectedAppointment)"
          aria-label="Marquer ce rendez-vous comme terminé">
          <span *ngIf="isUpdating(selectedAppointment)">Mise à jour...</span>
          <span *ngIf="!isUpdating(selectedAppointment)">✓ Marquer comme terminé</span>
        </button>
      </div>
    </div>
  </div>
</div>

